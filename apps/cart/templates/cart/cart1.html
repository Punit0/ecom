{% extends 'core/base.html' %}
{% block carousel %} {% endblock %}

{% block content %}

<main class="mt-5 pt-4">
  <div class="container wow fadeIn" id="mycartapp">

    {% if cart %}
   

    <div class="row">
      
      <!--Grid column-->
      <div class="col-lg-8">
  
        <!-- Card -->
        <div class="mb-3">
          <div class="pt-5 wish-list">

          
            <!-- looping goes here-->

            <div class="row mb-5" v-for="product in products ">

              <div class="col-md-5 col-lg-2 col-xl-2">
                <div class="view zoom overlay z-depth-1 rounded mb-3 mb-md-0">
                  <img class="img-fluid w-100"
                    v-bind:src="[[product.image]]" alt="Sample">
                </div>
              </div>
              <div class="col-md-6 col-lg-5 col-xl-9">
                <div>
                  <div class="d-flex justify-content-between">
                    <div>
                      <h5>[[product.title]]</h5>
                      
                      <p class="mb-3 text-muted text-uppercase small">Size: M</p>

                    </div>
                    <div>
                      <div class="def-number-input number-input safari_only mb-0 w-100">
                        <button  @click="decrementQuantity(product.id,product.quantity,product.price)" class="btn btn-info btn-sm">-</button> [[product.quantity]] <button  @click="incrementQuantity(product.id,product.quantity,product.price)" class="btn btn-info btn-sm">+</button>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <button  @click="removeFromCart(product.id)" class="btn btn-danger btn-sm card-link-secondary small text-uppercase mr-3" type="button">
                        <i  class="fas fa-trash-alt mr-1"> Remove Item</i>
                      </button>
                      
                    </div>
                    <p class="mb-0"><span><strong id="summary">RS. [[ product.total_price ]]</strong></span></p class="mb-0">
                  </div>
                </div>
              </div>
            </div>
            <!-- looping ends here-->


            <hr class="mb-4">

            
            <p class="text-primary mb-0"><i class="fas fa-info-circle mr-1"></i> Do not delay the purchase, adding
              items to your cart does not mean booking them.</p>
  
          </div>
        </div>
        <!-- Card -->
  
        
      </div>

      <div class="col-lg-4 verticalLine">
  
        <!-- Card -->
        <div class="mb-3">
          <div class="pt-4">
  
            <h5 class="mb-3 text-center">Summary</h5>
  
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                Temporary amount
                <span>RS. [[totalCost]]</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                Shipping
                <span>0</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                <div>
                  <strong>The total amount of</strong>
                  <strong>
                    <p class="mb-0">(including VAT)</p>
                  </strong>
                </div>
                <span><strong>RS. [[totalCost]]</strong></span>
              </li>
            </ul>
            
            <button type="button" class="btn btn-primary btn-block">go to checkout</button>
  
          </div>
        </div>
        <!-- Card -->
  
        
      </div>
      <!--Grid column-->
    </div>
    
    {% else %}

    <p> Your bag is empty</p>

    {% endif %}


  </div>
</main>
      


{% endblock %}

{% block scripts %}

<script>
  var mycartapp = new Vue({
    el: '#mycartapp',
    delimiters: ['[[',']]'],

    store:store,

    data() {
      return {
        products: [{{productsstring|safe}}]
      }
    },

    computed: {
        numItems: function() {
           return store.state.numItems
                  },

        totalCost: function(){
            return store.state.totalCost
                  }
                },
    methods: {
        incrementQuantity(product_id, quantity, price){
          console.log('product_id',product_id);

          var data = {
            'product_id': product_id,
            'update': true,
            'quantity': parseInt(quantity) + 1
          };

          store.commit('increment',1)
          store.commit('changeTotalCost',parseFloat(price));


          fetch('/api/add_to_cart/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'

            },

            credentials: 'same-origin',
            body: JSON.stringify(data)

          })

          .then((response) => {
            console.log(response);

            for(var i =0; i<this.products.length;i++){
              var product = this.products[i];

              if(product.id == product_id)
              {
                this.products[i].quantity =  parseInt(this.products[i].quantity) +1 ;
                this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)

              }



            }

          })

          .catch(function (error){
            console.log('Error 2');
            console.log(error);


          })


        },

        removeFromCart(product_id) {
          console.log('Product_id', product_id);
          
          var data = {
            'product_id':product_id


          };

          fetch('/api/remove_from_cart/',{
            method: 'POST',

            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },

            credentials: 'same-origin',
            body: JSON.stringify(data)

          })

          .then((response) =>{
            console.log(response);
            this.products = this.products.filter(product => product.id !== product_id)

          })

          .catch(function (error) {

            console.log('Error');
            console.log(error);


          })

        },

        decrementQuantity(product_id, quantity, price){

          console.log('product_id', product_id);

      
          var data = {
            'product_id': product_id,
            'update': true,
            'quantity': parseInt(quantity) - 1
          };

          if(parseInt(quantity) - 1  === 0 ){
              this.removeFromCart(product_id);
          }

          else{

            store.commit('increment', -1);
            store.commit('changeTotalCost', -parseFloat(price));

            fetch('/api/add_to_cart/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken':'{{ csrf_token }}'
              },

              credentials: 'same-origin',
              body : JSON.stringify(data)
            
            })
            
            .then((response) => {
              console.log(response)

              for(var i = 0 ; i<this.products.length;i++){
               
                var product = this.products[i];

                if(product.id == product_id)
                {
                  this.products[i].quantity = parseInt(this.products[i].quantity) -1;
                  this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price);

                }

            }})

            .catch(function(error){

              console.log('Error while decrementing')
              console.log(error)

           })

          }

        },
      



    },
    


  })


</script>


{% endblock %}